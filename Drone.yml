#Drone CI File!
#Commit Message: Drone! Captain Canary is here! 

kind: pipeline
type: kubernetes
name: API


steps:
- &cache_settings
  name: restore-cache
  image: drillster/drone-volume-cache
  settings:
    restore: true
    mount:
      - target
  volumes:
  - name: cache
    path: /cache
     
- name: prepare
  image: busybox
  commands:
    - mkdir -p /cache/${DRONE_REPO}/target
    - mkdir -p /cache/${DRONE_REPO}/m2
  volumes:
    - name: cache
      path: /cache
  workspace: new
        
- name: build
  pull: default
  image: 525918504241.dkr.ecr.us-west-2.amazonaws.com/saikrishna-api:latest
  commands:
    #- sed -i '/^<\/settings.*/i  <localRepository>\/drone\/src<\/localRepository>' /usr/share/maven/conf/settings.xml
    - cat /usr/share/maven/conf/settings.xml 
    - "mvn -Dskiptests clean install"
    - ls ./target -la
    - ls -al 
    - ls -al /root
    #- ls -al /root/.m2
    - pwd
    - ls -al /
    - ls -al ~/
    - whoami
  #volumes:
   # - name: m2
    #  path: /root/.m2

- <<: *cache_settings
  name: rebuild-cache
  settings:
    rebuild: true

#- name: rebuild-cache
#  image: drillster/drone-volume-cache
#  settings:
#    rebuild: true
#    mount:
#      - /root/.m2
#  volumes:
#  - name: cache
#    path: /cache


 
#- name: upload
#  image: plugins/s3
#  settings:
#    bucket: artifactory-cicd-drone
#    region: us-west-2
#    access_key:
#      from_secret: AWS_ID
#    secret_key:
#      from_secret: AWS_SECRET
#    source: target/*
#    target: api-targets/${DRONE_BUILD_NUMBER}
   
   
volumes:
  - name: cache
    host:
      path: /var/cache
  - name: target
    host:
      path: /var/cache/${DRONE_REPO}/target
  - name: m2
    persistentVolumeClaim:
      claimName: drone-cicd-efs-claim
