#Drone CI File!
#Commit Message: Drone! Captain Canary is here! 

kind: pipeline
type: kubernetes
name: API


steps:
- name: restore-cache
  image: meltwater/drone-cache:dev
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_ID
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_SECRET
  pull: true
  settings:
    restore: true
    bucket: artifactory-cicd-drone
    region: us-west-2
    mount:
      - 'vendor'

- name: testcache
  image: golang:1.11-alpine
  pull: true
  commands:
    - apk add --update make git
    - make drone-cache
    
- name: build
  pull: default
  image: maven:3.6-openjdk-8-slim
  commands:
    #- tar xzf 
    - make drone-cache
    - "mvn -Dskiptests clean install"
    - ls ./target -la
    - ls -al /root
    - ls -al /root/.m2
    - pwd
    - ls -al ../
    - ls -al ~/
    - whoami
    #- cd /root && tar czf /drone/src/target/maven-cache.tar.gz .m2/
    
- name: rebuild-cache
  image: meltwater/drone-cache:dev
  pull: true
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_ID
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_SECRET
  settings:
    rebuild: true
    bucket: artifactory-cicd-drone
    region: us-west-2
    mount:
      - 'vendor'
 
- name: upload
  image: plugins/s3
  settings:
    bucket: artifactory-cicd-drone
    region: us-west-2
    access_key:
      from_secret: AWS_ID
    secret_key:
      from_secret: AWS_SECRET
    source: target/*
    target: api-targets/${DRONE_BUILD_NUMBER}


- name: checkbox
  image: busybox
  commands:
    - ls -al target
    - ls -al /root
    - ls -al .mvn
    - ls -al 
    - df -h

