#Drone CI File!
#Commit Message: Drone! Captain Canary is here! 

kind: pipeline
type: kubernetes
name: API


steps:
- name: restore-cache
  image: drillster/drone-volume-cache
  settings:
    restore: true
    mount:
      - /root/.m2
  volumes:
  - name: cache
    path: /cache
    
- name: build
  pull: default
  image: maven:3.6-openjdk-8-slim
  commands:
    - "mvn -Dskiptests clean install"
    - ls ./target -la
    - ls -al /root
    - ls -al /root/.m2
    - pwd
    - ls -al ../
    - ls -al ~/
    - whoami
    #- cd /root && tar czf /drone/src/target/maven-cache.tar.gz .m2/
    
- name: rebuild-cache
  image: drillster/drone-volume-cache
  settings:
    rebuild: true
    mount:
      - /root/.m2
  volumes:
  - name: cache
    path: /cache


 
#- name: upload
#  image: plugins/s3
#  settings:
#    bucket: artifactory-cicd-drone
#    region: us-west-2
#    access_key:
#      from_secret: AWS_ID
#    secret_key:
#      from_secret: AWS_SECRET
#    source: target/*
#    target: api-targets/${DRONE_BUILD_NUMBER}
    
volumes:
- name: cache
  persistentVolumeClaim:
    claimName: drone-cicd-efs-claim
